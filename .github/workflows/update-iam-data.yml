name: Update IAM Data

on:
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Need full history for tags

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Update iam-expand package
        run: npm update @cloud-copilot/iam-expand @cloud-copilot/iam-data

      - name: Regenerate IAM data
        run: npm run generate-iam-data

      - name: Rebuild action
        run: npm run build

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet src/iam-actions.ts; then
            echo "No changes detected - IAM data is up to date"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected - will commit and tag new version"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: No changes detected
        if: steps.changes.outputs.changed == 'false'
        run: echo "IAM action data is already up to date. Nothing to commit."

      - name: Commit, tag, and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/iam-actions.ts dist/ package-lock.json
          git commit -m "chore: update IAM action data"
          git push

          # Get current version and bump patch
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"

          # Create new version tag
          git tag -a "$NEW_VERSION" -m "Update IAM data"
          git push origin "$NEW_VERSION"

          # Update floating major version tag (e.g., v1)
          git tag -fa "$MAJOR" -m "Update $MAJOR to $NEW_VERSION"
          git push origin "$MAJOR" --force
